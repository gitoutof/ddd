
name: ddd

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  REPO_URL: https://github.com/Lienol/openwrt
  REPO_BRANCH: 19.07
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: x86/lienol_bypass.config
  DIY_P1_SH: feed.sh
  DIY_P2_SH: x86/diy_bypass.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: true
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai


jobs:
  build:
    runs-on: ubuntu-18.04

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
           echo Hello, world!
           echo $DEBIAN_FRONTEND
           pwd
           ls -al
           whoami
           ls -al /etc/apt/sources.list.d/* 
           ls -al /usr/share/dotnet 
           ls -al /usr/local/lib/android 
           ls -al /opt/ghc
           sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
           sudo -E apt-get -qq update
           
           curl https://raw.githubusercontent.com/Lienol/openwrt/19.07/README.md | grep -e 'sudo apt-get -y .*' | head -n1 | sed 's/sudo apt-get -y install //g'
   
           sudo -E apt-get -qq install $(curl https://raw.githubusercontent.com/Lienol/openwrt/19.07/README.md | grep -e 'sudo apt-get -y .*' | head -n1 | sed 's/sudo apt-get -y install //g')
           sudo -E apt-get -qq autoremove --purge
           sudo -E apt-get -qq clean
           sudo timedatectl set-timezone "$TZ"
           sudo mkdir -p /workdir
           sudo chown $USER:$GROUPS /workdir
           
      - name: Clone source code
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
          ls -al /workdir
          ls -al /workdir/openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          cat openwrt/feeds.conf.default
          
      - name: Clone other packages
        run: |
          ls -al /workdir/openwrt/package
          git clone --depth 1 https://github.com/esirplayground/luci-theme-atmaterial-ColorIcon.git openwrt/package/luci-theme-atmaterial-ColorIcon
          ls -al /workdir/openwrt/package
          pwd
          ls -al
          git clone --depth 1 https://github.com/rosywrt/luci-theme-rosy.git && mv luci-theme-rosy/luci-theme-rosy openwrt/package/luci-theme-rosy
          ls -al
          git clone --depth 1 -b master https://github.com/vernesong/OpenClash.git && mv OpenClash/luci-app-openclash openwrt/package/luci-app-openclash
          git clone --depth 1 https://github.com/pymumu/smartdns.git openwrt/package/smartdns
          git clone --depth 1 -b lede https://github.com/pymumu/luci-app-smartdns.git openwrt/package/luci-app-smartdns
          ls -al /workdir/openwrt/package
          
      - name: Load custom feeds
        run: |
          ls -al
          pwd
          [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
          cat openwrt/feeds.conf.default
          
          chmod +x $DIY_P1_SH
          cd openwrt
          pwd 
          ls -al
          cat $GITHUB_WORKSPACE/$DIY_P1_SH
          $GITHUB_WORKSPACE/$DIY_P1_SH
          
      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ls -al ./feeds/luci/applications/luci-app-smartdns
          ls -al ./feeds/packages/net/smartdns
          
          rm -rf ./feeds/luci/applications/luci-app-smartdns
          rm -rf ./feeds/packages/net/smartdns

      - name: Install feeds
        run: |
          pwd
          ls -al
          cd openwrt 
          ls -al
          ./scripts/feeds install -a

      # Runs a set of commands using the runners shell
      - name: Run a multi-line script
        run: |
          echo Add other actions to build,
          echo test, and deploy your project.
